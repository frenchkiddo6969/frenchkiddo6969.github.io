<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RTO Classique</title>
  <link rel="icon" href="http://i.soupco.net/u/89eqq2.png" type="image/png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f6f6;
      --muted:#9aa0a6;
      --accent:#e45fa8; /* pink accent like screenshot */
      --teal:#66b9ad;
      --card-shadow: 0 12px 30px rgba(14,20,25,0.12);
      font-family: 'Rubik', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#111;}

    /* Top band — simplified, no menu buttons */
    .topband{background:linear-gradient(90deg,var(--accent) 0%, #4aa0d6 60%);color:#fff;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;gap:18px;flex-wrap:nowrap;min-height:64px;overflow:hidden}
    .brand{display:flex;align-items:center;gap:14px}
    .brand img{height:48px;width:auto;max-width:260px;object-fit:contain}
    .top-actions{margin-left:auto;display:flex;align-items:center;gap:12px}
    .top-actions .weather{display:flex;align-items:center;gap:10px;white-space:nowrap}
    .weather img{width:40px;height:40px;display:block}
    .weather .temp{font-weight:800;font-size:17px}
    .weather .desc{font-size:12px;color:rgba(255,255,255,0.9)}

    .nav-mini{display:none}


    /* Hero area with player centered */
    .hero{background:linear-gradient(180deg,rgba(255,255,255,0.05),transparent);padding:28px 20px 40px;}
    .hero-inner{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:140px 1fr 320px;gap:22px;align-items:center}
    /* keep the left column element but make it visually invisible so layout/spacing remains unchanged */
    .logo-card{background:transparent;border-radius:18px;padding:12px;display:flex;align-items:center;justify-content:center;box-shadow:none}
    .logo-card img{width:110px;height:110px;object-fit:cover;border-radius:12px;display:none}

    .player-wrap{background:#fff;border-radius:16px;padding:18px 20px;box-shadow:var(--card-shadow);display:flex;flex-direction:column;gap:12px}
    .player-controls{display:flex;align-items:center;gap:14px}
    .play-btn{width:68px;height:68px;border-radius:50%;display:inline-grid;place-items:center;background:var(--accent);color:white;font-size:22px;border:none;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,0.12)}
    .meta{display:flex;flex-direction:column;gap:4px}
    .meta .title{font-weight:800;font-size:18px}
    .meta .subtitle{color:var(--muted);font-weight:600}
    .volume{flex:1}
    .volume input[type=range]{width:100%}

    /* Right column box (compact player details / extras not account/video) */
    .right-box{background:linear-gradient(180deg,#5aa8b8,#7a6ad6);border-radius:14px;color:white;padding:16px;box-shadow:var(--card-shadow)}
    .right-box h3{margin:0 0 8px;font-size:18px}
    .right-box p{margin:0;color:rgba(255,255,255,0.9)}

    /* Main — News replaces the team area */
    main{max-width:1200px;margin:26px auto;padding:0 20px}
    .section-title{display:inline-block;background:#63b9ad;color:#fff;padding:10px 16px;border-radius:8px;font-weight:800;margin-bottom:18px}
    .news-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    .news-card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:var(--card-shadow);display:flex;flex-direction:column}
    .news-card img{width:100%;height:160px;object-fit:cover}
    .news-card .body{padding:12px}
    .news-card .body h4{margin:0 0 8px;font-size:16px}
    .news-card .body p{margin:0;color:var(--muted);font-size:14px}

    footer{max-width:1200px;margin:40px auto;padding:24px 20px;color:var(--muted)}

    @media (max-width:1000px){
      .hero-inner{grid-template-columns:120px 1fr}
      .right-box{grid-column:1 / -1}
      .news-grid{grid-template-columns:1fr 1fr}
    }
    @media (max-width:640px){
      .hero-inner{grid-template-columns:1fr}
      .topband{padding:12px}
      .news-grid{grid-template-columns:1fr}
      .logo-card img{width:80px;height:80px}
    }
  </style>
</head>
<body>

  <div class="topband">
    <div class="brand"><img id="site-logo" src="https://i.soupco.net/u/0w4rFz.png" alt="logo"/></div>
    <div class="top-actions">
      <div class="weather" aria-hidden="false">
        <img id="weather-icon-top" src="" alt="weather icon">
        <div style="display:flex;flex-direction:column;align-items:flex-end;line-height:1">
          <div class="temp" id="weather-text-top">--°C</div>
          <div class="desc" id="weather-desc-top">Loading</div>
        </div>
      </div>
    </div>
  </div>

  <section class="hero">
    <div class="hero-inner">
      <div class="logo-card">
        <!-- intentionally left visually empty to preserve spacing but hide the white box -->
      </div>

      <div class="player-wrap">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;gap:12px;align-items:center">
            <div style="background:var(--teal);padding:6px 10px;border-radius:10px;color:#fff;font-weight:800">Live</div>
            <div style="color:var(--muted);font-weight:700">Streaming Now</div>
          </div>
        </div>

        <div class="player-controls">
          <button id="playBtn" class="play-btn" aria-label="Play/Pause">▶</button>
          <div class="meta">
            <div class="title" id="now-title">—</div>
            <div class="subtitle" id="now-sub" style="display:none">&nbsp;</div>
          </div>
          <div class="volume">
            <audio id="audioPlayer" src="https://radio.soupco.net:8443/rtoclassique" preload="none"></audio>
            <input id="volumeSlider" type="range" min="0" max="1" step="0.01" value="1" aria-label="Volume" title="Volume">
          </div>
        </div>

        <!-- bottom "now playing" metadata area removed as requested -->

      </div>
    </div>
  </section>

  <main>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 class="section-title">News</h2>
      <div style="color:var(--muted);font-weight:600">Provided by France24</div>
    </div>

    <div id="newsContainer" class="news-grid" style="margin-top:14px">
      <!-- news injected by JS -->
    </div>
  </main>

  <footer>
    <div style="display:flex;justify-content:space-between;align-items:center;gap:20px">
      <div>© <strong>Radio-Télévision Occitane</strong></div>
    </div>
  </footer>

<script>
// === Config ===
const STREAM_URL = 'https://radio.soupco.net:8443/rtoclassique';
const LOGO_MAIN = 'https://i.soupco.net/u/0w4rFz.png';

const STATUS_URL = (() => { try { const u=new URL(STREAM_URL); return u.origin + '/status-json.xsl'; } catch(e){ return ''; }})();
const RSS_URL = 'https://www.france24.com/en/rss';
const RSS_PROXY = 'https://api.allorigins.win/raw?url='; // for demo; replace with your CORS proxy in production
const WEATHER_URL = 'https://api.open-meteo.com/v1/forecast?latitude=43.184&longitude=3.003&current_weather=true&temperature_unit=celsius&windspeed_unit=kmh';

const $ = s => document.querySelector(s);
const audio = $('#audioPlayer');
const playBtn = $('#playBtn');
const volumeSlider = $('#volumeSlider');
const nowTitle = $('#now-title');
const nowSub = $('#now-sub');
const newsContainer = $('#newsContainer');
const weatherTextTop = document.getElementById('weather-text-top');
const weatherDescTop = document.getElementById('weather-desc-top');
const weatherIconTop = document.getElementById('weather-icon-top');

// apply logos
document.getElementById('site-logo').src = LOGO_MAIN;

audio.src = STREAM_URL;
audio.crossOrigin = 'anonymous';

// play/pause
let isPlaying = false;
playBtn.addEventListener('click', async ()=>{
  if(!isPlaying){
    try{ await audio.play(); isPlaying=true; playBtn.textContent='❚❚'; }
    catch(e){ console.warn('Autoplay failed',e); }
  } else { audio.pause(); isPlaying=false; playBtn.textContent='▶'; }
});

volumeSlider.addEventListener('input', ()=>{ audio.volume = parseFloat(volumeSlider.value); });
audio.volume = parseFloat(volumeSlider.value || 1);

/* Mojibake fixer (UTF-8-first) */
function containsCyrillic(s){ try { return /\p{Script=Cyrillic}/u.test(s); } catch(e){ return false; } }
function looksLikeMojibake(s){ if(!s||typeof s!=='string') return false; if(containsCyrillic(s)) return false; if(/[À-ÿ]/.test(s) && /[ÃÐÂ]/.test(s)) return true; if(/Ã[A-Za-z\u00A0-\u00BF]/.test(s)) return true; return false; }
function toBytesFromVisibleChars(str){ return new Uint8Array([...str].map(ch=>ch.charCodeAt(0)&0xFF)); }
function tryDecode(bytes,enc){ try { return new TextDecoder(enc).decode(bytes); } catch(e){ return null; } }
function fixMojibake(s){ if(!s||typeof s!=='string') return s; if(containsCyrillic(s)) return s; if(!looksLikeMojibake(s)) return s; const bytes = toBytesFromVisibleChars(s); const viaUtf8 = tryDecode(bytes,'utf-8'); if(viaUtf8 && (containsCyrillic(viaUtf8) || /[^\u0000-\u007f]/.test(viaUtf8))) return viaUtf8; const viaWin1251 = tryDecode(bytes,'windows-1251'); if(viaWin1251 && containsCyrillic(viaWin1251)) return viaWin1251; if(viaUtf8) return viaUtf8; if(viaWin1251) return viaWin1251; return s; }

// fetch icecast status for now-playing
async function fetchNowPlaying(){
  if(!STATUS_URL) return;
  try{
    const res = await fetch(STATUS_URL);
    if(!res.ok) throw new Error('status fetch failed');
    const buf = await res.arrayBuffer();
    let txt = new TextDecoder('utf-8').decode(buf);
    let js = null;
    try{ js = JSON.parse(txt); } catch(e){
      const fallbacks=['windows-1251','iso-8859-1'];
      for(const enc of fallbacks){ try{ txt = new TextDecoder(enc).decode(buf); js=JSON.parse(txt); break;}catch(_){} }
    }
    if(!js) throw new Error('Could not parse status JSON');
    const icestats = js.icestats;
    let sources = icestats && icestats.source ? icestats.source : null;
    let src = null;
    if(Array.isArray(sources)){
      src = sources.find(s=> (s.listenurl && s.listenurl.includes('rtoclassique')) || (s.mount && s.mount.includes('rtoclassique')) );
    } else if(sources){ src = sources; }
    if(src){
      const rawTitle = src.title || src.server_name || '';
      const rawArtist = src.artist || src.song || '';
      const t0 = String(rawTitle || rawArtist || '');
      const title = fixMojibake(t0);
      nowTitle.textContent = title || '—';
      const descRaw = src.server_description || src.genre || '';
      const desc = (function(d){ if(!d) return ''; const s=String(d).trim(); const bad=/unspecified description|unspecified|unknown|n\/a|none/i; return bad.test(s)?'':s; })(descRaw);
      nowSub.textContent = fixMojibake(desc);
      nowSub.style.display = nowSub.textContent.trim() ? '' : 'none';
      // we intentionally no longer set a second metadata "now playing" area — only the main title/subtitle are updated
    }
  }catch(e){ console.warn('Could not fetch now playing', e); }
}
fetchNowPlaying(); setInterval(fetchNowPlaying,15000);

// Fetch France24 RSS via proxy and render first 6 items
async function fetchNews(){
  try{
    const res = await fetch(RSS_PROXY + encodeURIComponent(RSS_URL));
    if(!res.ok) throw new Error('news fetch failed');
    const buf = await res.arrayBuffer();
    let txt = new TextDecoder('utf-8').decode(buf);
    let doc = new DOMParser().parseFromString(txt,'text/xml');
    if(doc.querySelector('parsererror') || doc.querySelectorAll('item').length === 0){
      const fallbacks=['windows-1251','iso-8859-1'];
      for(const enc of fallbacks){ try{ txt = new TextDecoder(enc).decode(buf); doc = new DOMParser().parseFromString(txt,'text/xml'); if(!doc.querySelector('parsererror') && doc.querySelectorAll('item').length>0) break; }catch(_){} }
    }
    const items = Array.from(doc.querySelectorAll('item')).slice(0,6);
    if(items.length===0) return;
    let html = '';
    for(const it of items){
      const tRaw = it.querySelector('title')?.textContent || '';
      const dRaw = it.querySelector('description')?.textContent || '';
      const l = it.querySelector('link')?.textContent || '#';
      const im = it.querySelector('enclosure')?.getAttribute('url') || it.querySelector('media\\:content')?.getAttribute('url') || `https://picsum.photos/800/480?random=${Math.floor(Math.random()*1000)}`;
      const t = fixMojibake(tRaw);
      const d = fixMojibake((dRaw||'').replace(/<[^>]+>/g,''));
      html += `
        <article class="news-card">
          <a href="${l}" target="_blank" rel="noopener noreferrer"><img src="${im}" alt="news image"></a>
          <div class="body"><h4><a href="${l}" target="_blank" rel="noopener noreferrer">${t}</a></h4><p>${d.slice(0,140)}...</p></div>
        </article>
      `;
    }
    newsContainer.innerHTML = html;
  }catch(e){ console.warn('Could not fetch news', e); }
}
fetchNews();

// Weather icons (SVG to data URL) and mapping — unchanged
function svgToDataUrl(svg){ return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg); }
function getWeatherIcon(code){
  const sun = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><g stroke='#ffffff' stroke-width='1.6' stroke-linecap='round' stroke-linejoin='round' fill='none'><circle cx='12' cy='12' r='4'/></g><g stroke='#ffffff' stroke-width='1.6' stroke-linecap='round'><line x1='12' y1='1' x2='12' y2='3'/><line x1='12' y1='21' x2='12' y2='23'/><line x1='4.2' y1='4.2' x2='5.8' y2='5.8'/><line x1='18.2' y1='18.2' x2='19.8' y2='19.8'/><line x1='1' y1='12' x2='3' y2='12'/><line x1='21' y1='12' x2='23' y2='12'/><line x1='4.2' y1='19.8' x2='5.8' y2='18.2'/><line x1='18.2' y1='5.8' x2='19.8' y2='4.2'/></g></svg>`;
  const cloud = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='#ffffff' d='M19 15.5A3.5 3.5 0 0 0 15.5 12H15a4 4 0 0 0-7.9.9A3 3 0 0 0 4 16.9 3 3 0 0 0 7 20h11a1 1 0 0 0 1-1a3.5 3.5 0 0 0 0-3.5z'/></svg>`;
  const sunCloud = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><g stroke='#ffffff' stroke-width='1.6' stroke-linecap='round' stroke-linejoin='round' fill='none'><circle cx='8.5' cy='7.5' r='3'/></g><path fill='#ffffff' d='M19 15.5A3.5 3.5 0 0 0 15.5 12H15a4 4 0 0 0-7.9.9A3 3 0 0 0 4 16.9 3 3 0 0 0 7 20h11a1 1 0 0 0 1-1a3.5 3.5 0 0 0 0-3.5z'/></svg>`;
  const rain = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='#ffffff' d='M19 15.5A3.5 3.5 0 0 0 15.5 12H15a4 4 0 0 0-7.9.9A3 3 0 0 0 4 16.9 3 3 0 0 0 7 20h11a1 1 0 0 0 1-1a3.5 3.5 0 0 0 0-3.5z'/><g fill='#ffffff'><path d='M9 21c0 .6-.9 1-1 1s-1-.4-1-1 .9-1 1-1 1 .4 1 1zM15 21c0 .6-.9 1-1 1s-1-.4-1-1 .9-1 1-1 1 .4 1 1zM12 21c0 .6-.9 1-1 1s-1-.4-1-1 .9-1 1-1 1 .4 1 1z'/></g></svg>`;
  const snow = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='#ffffff' d='M19 15.5A3.5 3.5 0 0 0 15.5 12H15a4 4 0 0 0-7.9.9A3 3 0 0 0 4 16.9 3 3 0 0 0 7 20h11a1 1 0 0 0 1-1a3.5 3.5 0 0 0 0-3.5z'/><g stroke='#ffffff' stroke-width='1.6' stroke-linecap='round' stroke-linejoin='round' fill='none'><line x1='12' y1='17' x2='12' y2='21'/><line x1='10' y1='19' x2='14' y2='19'/><line x1='12' y1='3' x2='12' y2='7'/><line x1='10' y1='5' x2='14' y2='5'/></g></svg>`;
  const thunder = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='#ffffff' d='M19 15.5A3.5 3.5 0 0 0 15.5 12H15a4 4 0 0 0-7.9.9A3 3 0 0 0 4 16.9 3 3 0 0 0 7 20h11a1 1 0 0 0 1-1a3.5 3.5 0 0 0 0-3.5z'/><path fill='#ffffff' d='M11 14l-1 5 5-6h-4l1-8-5 6z'/></svg>`;
  const fog = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='#ffffff' d='M19 15.5A3.5 3.5 0 0 0 15.5 12H15a4 4 0 0 0-7.9.9A3 3 0 0 0 4 16.9 3 3 0 0 0 7 20h11a1 1 0 0 0 1-1a3.5 3.5 0 0 0 0-3.5z'/><g fill='#ffffff'><rect x='4' y='4' width='16' height='0' /><rect x='4' y='18' width='16' height='0' /><rect x='6' y='16' width='12' height='1'/><rect x='6' y='20' width='12' height='1'/></g></svg>`;

  if (code === 0 || code === 1) return svgToDataUrl(sun);
  if (code === 2) return svgToDataUrl(sunCloud);
  if (code === 3) return svgToDataUrl(cloud);
  if ([45,48].includes(code)) return svgToDataUrl(fog);
  if ([51,53,55,61,63,65].includes(code)) return svgToDataUrl(rain);
  if ([71,73,75].includes(code)) return svgToDataUrl(snow);
  if (code === 95) return svgToDataUrl(thunder);
  return svgToDataUrl(cloud);
}

async function fetchWeather(){
  try{
    const res = await fetch(WEATHER_URL);
    if(!res.ok) throw new Error('weather fetch failed');
    const js = await res.json();
    const w = js.current_weather; if(!w) return;
    const temp = w.temperature; const code = w.weathercode; const desc = weatherCodeToText(code);
    if(weatherTextTop) weatherTextTop.textContent = `${Number(temp).toFixed(1)}°C`;
    if(weatherDescTop) weatherDescTop.textContent = desc;
    if(weatherIconTop) weatherIconTop.src = getWeatherIcon(code);
  }catch(e){ console.warn('Could not fetch weather', e); if(weatherTextTop) weatherTextTop.textContent='--°C'; if(weatherDescTop) weatherDescTop.textContent=''; if(weatherIconTop) weatherIconTop.src=''; }
}

function weatherCodeToText(code){
  const map = {0:'Clear',1:'Mainly clear',2:'Partly cloudy',3:'Overcast',45:'Fog',48:'Depositing rime fog',51:'Light drizzle',53:'Moderate drizzle',55:'Dense drizzle',61:'Slight rain',63:'Moderate rain',65:'Heavy rain',71:'Light snow',73:'Moderate snow',75:'Heavy snow',95:'Thunderstorm'};
  return map[code] || 'Weather';
}
fetchWeather(); setInterval(fetchWeather,15*60*1000);

console.info('Stream:',STREAM_URL,'Status:',STATUS_URL,'News:',RSS_URL);
</script>
</body>
</html>
